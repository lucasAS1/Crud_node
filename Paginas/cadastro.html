<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="Css/css/bootstrap.min.css" rel="stylesheet">
    <link href="Css/padroesdeestilo.css" rel="stylesheet">
    <title>Desafio node - Cadastro</title>
</head>
<body>

    <!--Barra de navegação-->
    <div class="navbar navbar-expand-lg navbar-dark bg-dark">
        <button class="navbar-toggler" 
            type="button" 
            data-toggle="collapse"
            data-target="#menuRetratil"
            aria-controls="menuRetratil"
            aria-expanded="false"
            aria-label="Expandir menu">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="menuRetratil">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item">
                    <a class="nav-link" href="/">Inicio</a>
                </li>
                <li class="nav-item active">
                    <a class="nav-link" href="#">Cadastrar</a>
                </li>
            </ul>
        </div>
    </div>

    <!--Conteudo da página-->
    <div class="container-fluid corpo ">
        <div class="row d-flex justify-content-center ">
            <div class="col-10 m-5">
                <div class="card bg-dark">
                    <div class="card-header">
                        <p class="lead">Formulário de cadastro</p>
                    </div>
                    <div class="card-body">
                        <form class="form-group" method="POST" id="frmCadastro" action="cadastroAPI">
                            <input type="hidden" id="hdnId">
                            <div class="row d-flex justify-content-center">
                                <div class="col-4">
                                    <label for="txtNome">Nome:</label>
                                    <input class="form-control" type="text" id="txtNome" placeholder="Digite o nome">
                                </div>
                                <div class="col-4">
                                    <label for="txtCPF">CPF:</label>
                                    <input 
                                    class="form-control"
                                    type="text"
                                    id="txtCPF"
                                    placeholder="Digite o CPF">
                                </div>
                                <div class="col-4">
                                    <label for="txtTelefone">Telefone:</label>
                                    <input 
                                    class="form-control" 
                                    type="text" 
                                    id="txtTelefone" 
                                    placeholder="Digite o telefone">
                                </div>
                            </div>
                            <div class="row d-flex justify-content-center pt-5">
                                <div class="col-4">
                                    <label for="txtEmail">Email:</label>
                                    <input 
                                    class="form-control" 
                                    type="text" 
                                    id="txtEmail" 
                                    placeholder="Digite o email">
                                </div>
                                <div class="col-4">
                                    <label for="slcDepart">Departamento:</label>
                                    <select class="form-control" id="slcDepart">
                                        <option selected value="N/A">Escolha</option>
                                        <option value="1">TI</option>
                                        <option value="2">RH</option>
                                        <option value="3">Limpeza</option>
                                        <option value="4">Operacional</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row pt-4 d-flex justify-content-center">
                                <div class="col-6  d-flex justify-content-center">
                                    <button class="btn-danger btn" type="button" id="btnCancelar" value="Cancelar" onclick="">Cancelar</button>
                                </div>
                                <div class="col-6  d-flex justify-content-center">
                                    <button class="btn-primary btn" type="button" id="btnSubmit" value="Cadastrar">Cadastrar</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!--Scripts JS-->
    <script src="JS/jquery/dist/jquery.min.js"></script>
    <script src="JS/bootstrap/bootstrap.min.js"></script>
    <script src="JS/inputmask.min.js"></script>
    <script src="JS/jquery.mask.min.js"></script>
    <script src="JS/regexCampos.js"></script>
    <script>
        $(document).ready(async()=>{
            let query=window.location.search;
            let req=new URLSearchParams(query);
            let id=req.get('id');

            if(id==undefined)
            { 
                document.getElementById('btnSubmit').onclick=async()=>{
                    await fetch('/save_cadastro',{
                        headers:{
                            "Content-Type":"application/json; charset=utf-8"
                        },
                        method:'POST',
                        body:JSON.stringify({
                            txtNome:document.getElementById('txtNome').value,
                            txtCPF:document.getElementById('txtCPF').value.replace(/\D/g,''),
                            txtTelefone:document.getElementById('txtTelefone').value.replace(/\D/g,''),
                            txtEmail:document.getElementById('txtEmail').value,
                            slcDepart:document.getElementById('slcDepart').selectedIndex
                        })
                    });
                    window.location.href="/";
                };
                return;
            }
            const res=await fetch(`/view_cadastro?id=${id}`);
            const json=await res.json();
            document.getElementById('txtNome').value=json[0].nome;
            document.getElementById('txtCPF').value=json[0].cpf;
            document.getElementById('txtTelefone').value=json[0].telefone;
            document.getElementById('txtEmail').value=json[0].email;
            switch(json[0].nome_depart){
                case "TI":
                    document.getElementById('slcDepart').selectedIndex=1;
                    break;
                case "RH":
                    document.getElementById('slcDepart').selectedIndex=2;
                    break;
                case "Limpeza":
                document.getElementById('slcDepart').selectedIndex=3;
                break;
                case "Operacional":
                    document.getElementById('slcDepart').selectedIndex=4;
                    break;
                default:
                case "TI":
                    document.getElementById('slcDepart').selectedIndex=0;
            };
            document.getElementById('hdnId').value=json[0].id_func;
            
            document.getElementById('btnSubmit').onclick=async()=>{await fetch('/update_cadastro',{
                        headers:{
                            "Content-Type":"application/json; charset=utf-8"
                        },
                        method:'POST',
                        body:JSON.stringify({
                            txtNome:document.getElementById('txtNome').value,
                            txtCPF:document.getElementById('txtCPF').value.replace(/\D/g,''),
                            txtTelefone:document.getElementById('txtTelefone').value.replace(/\D/g,''),
                            txtEmail:document.getElementById('txtEmail').value,
                            slcDepart:document.getElementById('slcDepart').selectedIndex,
                            hdnId:document.getElementById('hdnId').value
                        })
                    });
                    window.location.href="/";
                }
        })
    </script>

    <!--Rodapé da página-->
    <footer class="rodape">
        <div class="d-flex justify-content-center align-middle">
            <p class="lead">Desenvolvido por Lucas Alves da Silva</p>
        </div>
    </footer>
</body>
</html>